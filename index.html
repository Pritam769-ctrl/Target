<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Target v1.6</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        :root {
            /* Light Mode */
            --primary: #6c5ce7;
            --glass-bg: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(255, 255, 255, 0.6);
            --glass-shine: rgba(255, 255, 255, 0.4);
            --text: #1e1e1e;
            --text-sec: #666;
            --bg-grad-1: #e0c3fc;
            --bg-grad-2: #8ec5fc;
            --danger: #ff4757;
            --success: #2ed573;
            --surface: rgba(255, 255, 255, 0.4);
            --radius: 24px;
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        [data-theme="dark"] {
            /* Dark Glass Mode */
            --glass-bg: rgba(20, 20, 20, 0.85);
            --glass-border: rgba(255, 255, 255, 0.12);
            --glass-shine: rgba(255, 255, 255, 0.05);
            --text: #e0e0e0;
            --text-sec: #a0a0a0;
            --bg-grad-1: #0f2027;
            --bg-grad-2: #203a43;
            --surface: rgba(0, 0, 0, 0.4);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.6);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', sans-serif; }
        
        body {
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, var(--bg-grad-1), var(--bg-grad-2));
            min-height: 100vh;
            color: var(--text);
            overflow-x: hidden;
            transition: background 0.5s ease, color 0.3s ease;
        }

        /* Animations */
        @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .anim-slide { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        .anim-pop { animation: popIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* Glass Components */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-top: 1px solid var(--glass-shine);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .btn {
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            font-size: 1rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.4); }
        .btn-outline { background: transparent; border: 1px solid var(--text); color: var(--text); }
        .btn-danger { background: var(--danger); color: white; }
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
        
        /* Inputs & Textareas */
        input, textarea, select {
            width: 100%;
            padding: 14px;
            border-radius: 16px;
            border: 1px solid var(--glass-border);
            background: var(--surface);
            color: var(--text);
            font-size: 1rem;
            margin-bottom: 10px;
            transition: 0.3s;
            resize: none; 
            overflow: hidden;
            font-family: inherit;
        }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); background: rgba(255,255,255,0.05); }

        /* Layout */
        #app { padding-bottom: 110px; max-width: 600px; margin: 0 auto; min-height: 100vh; position: relative; }
        
        header {
            padding: 25px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        
        .app-branding {
            font-size: 2.2rem;
            font-weight: 900;
            letter-spacing: -1px;
            margin: 0;
            background: -webkit-linear-gradient(45deg, var(--primary), #a29bfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(108, 92, 231, 0.2);
        }

        .icon-btn { font-size: 1.6rem; cursor: pointer; color: var(--text); padding: 5px; transition: 0.2s; }
        .icon-btn:active { transform: scale(0.9); opacity: 0.7; }
        
        .section { display: none; padding: 20px; }
        .section.active { display: block; animation: slideUp 0.4s ease; }

        /* Custom Group Box */
        .group-box {
            background: var(--surface);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid var(--glass-border);
            position: relative;
        }
        .group-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--primary);
            font-weight: 700;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Navigation */
        .nav-bar {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 550px;
            display: flex;
            justify-content: space-between;
            padding: 15px 30px;
            z-index: 100;
            border-radius: 35px;
        }
        .nav-item {
            text-align: center;
            font-size: 0.75rem;
            opacity: 0.5;
            cursor: pointer;
            transition: 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .nav-item i { font-size: 1.6rem; margin-bottom: 2px; }
        .nav-item.active { opacity: 1; color: var(--primary); transform: translateY(-3px); }

        /* Floating Action Button (Global) */
        .fab-container {
            position: fixed;
            bottom: 105px;
            right: 25px;
            z-index: 90;
        }
        .fab { 
            width: 56px; height: 56px; 
            border-radius: 50%; 
            background: var(--primary); 
            color: white; 
            display: flex; align-items: center; justify-content: center; 
            font-size: 28px; 
            box-shadow: 0 8px 20px rgba(108, 92, 231, 0.4); 
            cursor: pointer; 
            transition: transform 0.2s, opacity 0.3s; 
            opacity: 1;
            pointer-events: auto;
        }
        .fab:active { transform: scale(0.9); }
        .fab.hidden { opacity: 0; pointer-events: none; transform: scale(0.8); }

        /* Setup */
        #setup-wizard {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 200; background: var(--bg-grad-1);
            display: flex; flex-direction: column; justify-content: center; padding: 30px;
        }

        /* Pills */
        .pills { display: flex; gap: 8px; margin-bottom: 20px; background: var(--surface); padding: 6px; border-radius: 50px; }
        .pill { flex: 1; text-align: center; padding: 10px; border-radius: 40px; cursor: pointer; transition: 0.3s; font-weight: 600; font-size: 0.9rem; }
        .pill.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }

        /* Cards */
        .card { padding: 0; margin-bottom: 15px; overflow: hidden; }
        .card-header { padding: 18px 20px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-weight: 600; }
        .card-content { display: none; padding: 0 20px 20px 20px; border-top: 1px solid var(--glass-border); }
        .card.expanded .card-content { display: block; animation: fadeIn 0.3s; }

        /* Dashboard specific */
        .target-box { text-align: center; padding: 30px 20px; position: relative; }
        .target-text { font-size: 1.6rem; font-weight: 800; background: -webkit-linear-gradient(45deg, var(--primary), #ff6b6b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-top: 5px; line-height: 1.3; }
        
        /* Planner */
        .date-scroller { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px; scrollbar-width: none; }
        .date-chip { min-width: 75px; text-align: center; padding: 12px 8px; border-radius: 18px; background: var(--surface); border: 1px solid var(--glass-border); cursor: pointer; display: flex; flex-direction: column; gap: 4px; }
        .date-chip span:first-child { font-size: 1.2rem; font-weight: bold; }
        .date-chip span:last-child { font-size: 0.75rem; text-transform: uppercase; opacity: 0.7; }
        .date-chip.active { background: var(--primary); color: white; border-color: var(--primary); }
        
        .task-item { display: flex; align-items: flex-start; padding: 15px; margin-bottom: 12px; border-radius: 16px; background: var(--surface); border: 1px solid var(--glass-border); }
        .task-checkbox { width: 22px; height: 22px; margin-right: 15px; margin-top: 2px; accent-color: var(--primary); }
        .task-content { flex: 1; }
        .task-content.done { text-decoration: line-through; opacity: 0.5; }
        .task-name { font-weight: 600; font-size: 1rem; }
        .task-time { font-size: 0.85rem; color: var(--text-sec); display: flex; align-items: center; gap: 4px; margin-top: 4px; }
        .task-del { color: var(--danger); cursor: pointer; padding: 5px; opacity: 0.7; font-size: 1.2rem; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 150; display: none; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal { width: 85%; max-width: 400px; padding: 30px; transform: scale(0.9); transition: 0.3s; max-height: 80vh; overflow-y: auto; }
        .modal.open { transform: scale(1); }
        .modal h3 { margin-top: 0; margin-bottom: 20px; }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0,0,0,0.2);
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(22px); }

        /* Settings */
        .setting-row { display: flex; justify-content: space-between; align-items: center; padding: 18px 0; border-bottom: 1px solid var(--glass-border); }
        .credits { margin-top: 40px; text-align: center; font-size: 0.8rem; color: var(--text-sec); opacity: 0.7; line-height: 1.6; }
        
        .hidden { display: none !important; }

        /* Read Me Styles */
        .readme-list { text-align: left; padding-left: 0; list-style: none; }
        .readme-list li { margin-bottom: 15px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; display: flex; gap: 12px; }
        .readme-list i { font-size: 1.4rem; color: var(--primary); margin-top: 2px; }
        .readme-list div { flex: 1; }
        .readme-list strong { color: var(--text); display: block; margin-bottom: 4px; }
        
        /* Utility */
        label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 0.9rem; color: var(--text-sec); }
    </style>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6c5ce7">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
</head>
<body>

    <div id="setup-wizard" class="hidden">
        <div class="glass" style="padding: 30px; text-align: center;">
            <i class="ph ph-target" style="font-size: 5rem; color: var(--primary); margin-bottom: 10px;"></i>
            <h1 class="app-branding" style="margin-bottom: 10px;">Target</h1>
            <p style="opacity: 0.8">Let's set you up for success.</p>
            <div style="text-align: left; margin-top: 30px;">
                <label>What should we call you?</label>
                <input type="text" id="setup-name" placeholder="First Name">
                
                <label style="margin-top: 20px;">Initial Task Pool</label>
                <textarea id="setup-tasks" rows="1" class="auto-expand">Eat, Play, Exercise, Study</textarea>
                <small style="color: var(--text-sec)">Separate tasks with commas</small>
            </div>
            <button class="btn btn-primary" style="width: 100%; margin-top: 30px;" onclick="completeSetup()">Get Started <i class="ph ph-arrow-right"></i></button>
        </div>
    </div>

    <div id="app">
        <header class="glass anim-slide" style="border-radius: 0 0 24px 24px; margin-top: -10px;">
            <h1 class="app-branding" id="header-title">Target</h1>
            <i class="ph ph-gear icon-btn" onclick="openSettings()"></i>
        </header>

        <div id="dashboard" class="section active">
            <div class="glass card anim-slide" style="margin-top: 10px; border-radius: 24px;">
                <div class="target-box">
                    <p style="font-size: 0.85rem; opacity: 0.6; text-transform: uppercase; margin: 0; letter-spacing: 1px;">My Goal</p>
                    <div id="target-display" class="target-text">Set your Goal!</div>
                    <div style="position: absolute; top: 15px; right: 15px; cursor: pointer; opacity: 0.6;" onclick="editTarget()">
                        <i class="ph ph-pencil-simple" style="font-size: 1.4rem;"></i>
                    </div>
                </div>
            </div>

            <div class="anim-slide" style="animation-delay: 0.1s">
                <div class="group-box">
                    <div class="group-title"><i class="ph ph-calendar-check"></i> Exam Schedule</div>
                    
                    <label>Internal Exams</label>
                    <textarea id="exam-internal" class="auto-expand" oninput="saveExams(this)" placeholder="Dates & Details..."></textarea>
                    
                    <label style="margin-top: 10px;">External Exams</label>
                    <textarea id="exam-external" class="auto-expand" oninput="saveExams(this)" placeholder="Dates & Details..."></textarea>
                </div>

                <div class="group-box">
                    <div class="group-title"><i class="ph ph-clock-countdown"></i> Upcoming Exams</div>
                    
                    <label>Internal</label>
                    <textarea id="up-internal" class="auto-expand" oninput="saveExams(this)" placeholder="Dates..."></textarea>
                    
                    <label style="margin-top: 10px;">External</label>
                    <textarea id="up-external" class="auto-expand" oninput="saveExams(this)" placeholder="Dates..."></textarea>
                </div>
            </div>
        </div>

        <div id="planner" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div>
                    <h2 style="margin: 0;">Hi, <span id="planner-name">User</span></h2>
                    <p style="margin: 0; opacity: 0.7; font-size: 0.9rem;">Let's plan your day</p>
                </div>
                <button class="btn btn-outline btn-sm" onclick="openTaskPoolEdit()">
                    <i class="ph ph-list-plus"></i> Pool
                </button>
            </div>
<textarea id="daily-note" class="auto-expand" rows="1" 
                placeholder="Daily Notes (Stays here everyday)..." 
                oninput="saveDailyNote(this)" 
                style="background: rgba(127, 127, 127, 0.1); border: none; padding: 10px; margin-bottom: 15px; min-height: 45px;"></textarea>
            <div class="date-scroller" id="date-container">
                </div>

            <div id="planner-list" style="padding-bottom: 80px;">
                </div>

            <div style="text-align: center; padding: 10px;">
                <button class="btn btn-primary glass" onclick="openAddTaskModal()">
                    <i class="ph ph-plus"></i> Add Plan
                </button>
            </div>
        </div>

        <div id="subjects" class="section">
    <div class="pills glass">
        <div class="pill active" onclick="switchSubTab('subjects', 'nursing')">Nursing</div>
        <div class="pill" onclick="switchSubTab('subjects', 'nonNursing')">Non-Nursing</div>
    </div>
    <div id="subjects-list"></div>
</div>

        <div id="practice" class="section">
    <div class="pills glass">
        <div class="pill active" onclick="switchSubTab('practice', 'nursing')">Nursing</div>
        <div class="pill" onclick="switchSubTab('practice', 'nonNursing')">Non-Nursing</div>
    </div>
    <div id="practice-list"></div>
</div>

        <div id="settings" class="section">
            <div class="glass" style="padding: 20px;">
                <h2 style="margin-top: 0;">Settings</h2>
                
                <div class="setting-row">
                    <span style="display: flex; align-items: center; gap: 10px;"><i class="ph ph-moon"></i> Dark Mode</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dark-toggle" onchange="toggleTheme()">
                        <span class="slider"></span>
                    </label>
                </div>
                
                <div class="setting-row">
                    <span style="display: flex; align-items: center; gap: 10px;"><i class="ph ph-user"></i> Change Name</span>
                    <button class="btn btn-outline btn-sm" onclick="changeName()">Edit</button>
                </div>

                <div class="setting-row" onclick="openReadme()" style="cursor: pointer;">
                    <span style="display: flex; align-items: center; gap: 10px;"><i class="ph ph-book-open-text"></i> Read Me / Help</span>
                    <i class="ph ph-caret-right"></i>
                </div>
                
                <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 12px;">
                    <button class="btn btn-primary" style="background-color: #3742fa;" onclick="backupData()">
                        <i class="ph ph-download-simple"></i> Backup Data
                    </button>
                    
                    <button class="btn btn-primary" style="background-color: #2ed573;" onclick="document.getElementById('restore-input').click()">
                        <i class="ph ph-upload-simple"></i> Restore Backup
                    </button>
                    <input type="file" id="restore-input" style="display: none" onchange="restoreData(this)">
                    
                    <button class="btn btn-danger" onclick="resetData()">
                        <i class="ph ph-trash"></i> Reset All Data
                    </button>
                </div>

                <div class="credits">
                    <p style="font-weight: bold; margin-bottom: 5px;">Target v1.6</p>
                    <p>Created by Pritam Roy</p>
                    <p>Support: <a href="mailto:rpritam906@gmail.com" style="color: inherit;">rpritam906@gmail.com</a></p>
                </div>
            </div>
        </div>
    </div>

    <div class="fab-container">
        <div id="main-fab" class="fab hidden" onclick="handleFabClick()">
            <i class="ph ph-plus"></i>
        </div>
    </div>

    <nav class="nav-bar glass">
        <div class="nav-item active" onclick="nav('dashboard')"><i class="ph ph-house"></i>Home</div>
        <div class="nav-item" onclick="nav('planner')"><i class="ph ph-calendar"></i>Plan</div>
        <div class="nav-item" onclick="nav('subjects')"><i class="ph ph-books"></i>Subjects</div>
        <div class="nav-item" onclick="nav('practice')"><i class="ph ph-pencil-circle"></i>Practice</div>
    </nav>

    <div id="modal-add-task" class="modal-overlay">
        <div class="glass modal">
            <h3>Add Plan</h3>
            <label>Select from Pool</label>
            <select id="task-select" onchange="syncTaskInput()"></select>
            
            <label style="margin-top: 10px;">Or Custom Name</label>
            <input type="text" id="task-custom">
            
            <div style="display: flex; gap: 15px; margin-top: 10px;">
                <div style="flex:1">
                    <label>From</label>
                    <input type="time" id="task-from">
                </div>
                <div style="flex:1">
                    <label>To</label>
                    <input type="time" id="task-to">
                </div>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px;">
                <button class="btn btn-outline" onclick="closeModal('modal-add-task')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmAddTask()">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-target" class="modal-overlay">
        <div class="glass modal">
            <h3>My Motivation</h3>
            <textarea id="target-input-modal" class="auto-expand" rows="3"></textarea>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                <button class="btn btn-outline" onclick="closeModal('modal-target')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTarget()">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-input" class="modal-overlay">
        <div class="glass modal">
            <h3 id="modal-input-title">Enter Name</h3>
            <input type="text" id="modal-input-field">
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                <button class="btn btn-outline" onclick="closeModal('modal-input')">Cancel</button>
                <button class="btn btn-primary" id="modal-input-confirm">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-pool" class="modal-overlay">
        <div class="glass modal">
            <h3>Edit Task Pool</h3>
            <textarea id="pool-edit-area" class="auto-expand" rows="4"></textarea>
            <small>Comma separated values</small>
            <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;">
                <button class="btn btn-outline" onclick="closeModal('modal-pool')">Cancel</button>
                <button class="btn btn-primary" onclick="saveTaskPool()">Save</button>
            </div>
        </div>
    </div>

    <div id="modal-readme" class="modal-overlay">
        <div class="glass modal">
            <h3>Read Me / Instructions</h3>
            <ul class="readme-list">
                <li>
                    <i class="ph ph-house"></i>
                    <div>
                        <strong>Dashboard</strong> 
                        Set your main Goal/Target text by tapping the pencil icon. Write down your Exam schedules in the boxes provided.
                    </div>
                </li>
                <li>
                    <i class="ph ph-calendar"></i>
                    <div>
                        <strong>Planner</strong> 
                        Plan up to 3 days in advance. Tap "+ Add Plan" to select a task. Tick the box when done.
                    </div>
                </li>
                <li>
                    <i class="ph ph-list-plus"></i>
                    <div>
                        <strong>Task Pool</strong> 
                        In Planner, tap "Pool" to edit your default tasks (e.g., Eat, Study).
                    </div>
                </li>
                <li>
                    <i class="ph ph-books"></i>
                    <div>
                        <strong>Subjects & Practice</strong> 
                        Tap (+). Tap the card title to Expand. Type notes. Use <i class="ph ph-trash" style="font-size: 1rem; color:var(--danger)"></i> to delete.
                    </div>
                </li>
                <li>
                    <i class="ph ph-gear"></i>
                    <div>
                        <strong>Settings</strong> 
                        Toggle Dark Mode, Backup your data (JSON), or Restore data.
                    </div>
                </li>
            </ul>
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="closeModal('modal-readme')">Got it!</button>
            </div>
        </div>
    </div>

    <script>
        /* --- UTILS --- */
        function initAutoExpand() {
            document.addEventListener('input', function (event) {
                if (event.target.tagName.toLowerCase() !== 'textarea') return;
                autoExpand(event.target);
            }, false);
        }
        function autoExpand(field) {
            field.style.height = 'inherit'; // Reset
            const computed = window.getComputedStyle(field);
            const height = parseInt(computed.getPropertyValue('border-top-width'), 10)
                         + parseInt(computed.getPropertyValue('padding-top'), 10)
                         + field.scrollHeight
                         + parseInt(computed.getPropertyValue('padding-bottom'), 10)
                         + parseInt(computed.getPropertyValue('border-bottom-width'), 10);
            field.style.height = height + 'px';
        }

        /* --- STATE MANAGEMENT --- */
        let appData = {
            user: '',
            tasks: ['Eat', 'Play', 'Exercise'],
            target: '',
            exams: { int: '', ext: '', upInt: '', upExt: '' },
            planner: {}, // Key: "DD Mon", Value: []
            subjects: { nursing: [], nonNursing: [] },
            practice: { nursing: [], nonNursing: [] },
            settings: { dark: false }
        };

        let currentSubTab = 'nursing'; 
        let currentSectionType = 'subjects'; 
        let selectedDate = ''; 

        /* --- INITIALIZATION --- */
        window.onload = () => {
            initAutoExpand();
            const saved = localStorage.getItem('targetAppData');
            if (saved) {
                appData = JSON.parse(saved);
                initApp();
            } else {
                document.getElementById('setup-wizard').classList.remove('hidden');
            }
        };

        function saveData() {
            localStorage.setItem('targetAppData', JSON.stringify(appData));
        }

        function completeSetup() {
            const name = document.getElementById('setup-name').value.trim();
            const taskStr = document.getElementById('setup-tasks').value;
            if(!name) return alert("Name is required");
            
            appData.user = name;
            appData.tasks = taskStr.split(',').map(t => t.trim()).filter(t => t);
            saveData();
            document.getElementById('setup-wizard').classList.add('hidden');
            initApp();
        }

        function initApp() {
            // Apply Theme
            if(appData.settings.dark) document.body.setAttribute('data-theme', 'dark');
            document.getElementById('dark-toggle').checked = appData.settings.dark;
            
            // Dashboard
            document.getElementById('target-display').innerText = appData.target || "Set your Goal!";
            
            const setVal = (id, val) => {
                const el = document.getElementById(id);
                el.value = val;
                setTimeout(() => autoExpand(el), 10); // Resize after set
            };
            
            setVal('exam-internal', appData.exams.int);
            setVal('exam-external', appData.exams.ext);
            setVal('up-internal', appData.exams.upInt);
            setVal('up-external', appData.exams.upExt);

            // Planner Setup
            document.getElementById('planner-name').innerText = appData.user;
            generateDates();
            // Load Daily Note
            const noteEl = document.getElementById('daily-note');
            noteEl.value = appData.dailyNote || "";
            setTimeout(() => autoExpand(noteEl), 50);
            nav('dashboard');
        }

        /* --- NAVIGATION --- */
        function nav(sectionId) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.querySelector(`.nav-item[onclick="nav('${sectionId}')"]`).classList.add('active');

            // Handle Global FAB Visibility
            const fab = document.getElementById('main-fab');
            if(sectionId === 'subjects' || sectionId === 'practice') {
                fab.classList.remove('hidden');
            } else {
                fab.classList.add('hidden');
            }

            if(sectionId === 'subjects' || sectionId === 'practice') {
                currentSectionType = sectionId;
                
                // Reset to Nursing default to avoid glitch
                currentSubTab = 'nursing'; 
                const root = document.getElementById(sectionId);
                const pills = root.querySelectorAll('.pill');
                pills.forEach(p => p.classList.remove('active'));
                pills[0].classList.add('active'); 

                renderList();
            } else if (sectionId === 'planner') {
                generateDates(); 
                renderPlanner();
                
                // --- FIX ADDED HERE ---
                // Automatically expand the Daily Note now that the page is visible
                setTimeout(() => {
                    const note = document.getElementById('daily-note');
                    if(note) autoExpand(note);
                }, 50); 
            }
        }

        function handleFabClick() {
            addSubjectItem(currentSectionType);
        }

        function openSettings() { nav('settings'); }

        /* --- DASHBOARD LOGIC --- */
        function editTarget() {
            document.getElementById('target-input-modal').value = appData.target;
            openModal('modal-target');
            setTimeout(() => autoExpand(document.getElementById('target-input-modal')), 50);
        }
        function saveTarget() {
            appData.target = document.getElementById('target-input-modal').value;
            document.getElementById('target-display').innerText = appData.target || "Set your Goal!";
            saveData();
            closeModal('modal-target');
        }
        function saveExams(el) {
            autoExpand(el); 
            appData.exams.int = document.getElementById('exam-internal').value;
            appData.exams.ext = document.getElementById('exam-external').value;
            appData.exams.upInt = document.getElementById('up-internal').value;
            appData.exams.upExt = document.getElementById('up-external').value;
            saveData();
        }

        /* --- SUBJECTS & PRACTICE LOGIC --- */
    function switchSubTab(section, type) {
    const root = document.getElementById(section);
    const pills = root.querySelectorAll('.pill');
    pills.forEach(p => p.classList.remove('active'));
    
    // Logic: type 'nursing' is index 0, 'nonNursing' is index 1
    if(type === 'nursing') pills[0].classList.add('active');
    else pills[1].classList.add('active');

    currentSubTab = type;
    currentSectionType = section;
    renderList();
}

        function renderList() {
            const containerId = currentSectionType === 'subjects' ? 'subjects-list' : 'practice-list';
            const list = appData[currentSectionType][currentSubTab];
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            list.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'glass card anim-slide';
                card.innerHTML = `
                    <div class="card-header" onclick="toggleCard(this)">
                        ${item.title} <i class="ph ph-caret-down"></i>
                    </div>
                    <div class="card-content">
                        <textarea class="auto-expand" rows="1" placeholder="Write notes here..." oninput="saveCardText('${currentSectionType}', '${currentSubTab}', ${index}, this)">${item.text || ''}</textarea>
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 0;">
                             <div class="icon-btn" style="color: var(--danger); font-size: 1.3rem;" onclick="deleteCard('${currentSectionType}', '${currentSubTab}', ${index})">
                                <i class="ph ph-trash"></i>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="toggleCard(this.closest('.card').querySelector('.card-header'))">Done</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function addSubjectItem(section) {
            currentSectionType = section;
            document.getElementById('modal-input-title').innerText = "New " + (section === 'subjects' ? "Subject" : "Practice Set");
            document.getElementById('modal-input-field').value = "";
            
            const confirmBtn = document.getElementById('modal-input-confirm');
            confirmBtn.onclick = () => {
                const val = document.getElementById('modal-input-field').value;
                if(val) {
                    appData[currentSectionType][currentSubTab].push({ title: val, text: '' });
                    saveData();
                    renderList();
                    closeModal('modal-input');
                }
            };
            openModal('modal-input');
        }

        function deleteCard(section, tab, index) {
            if(confirm("Delete this item permanently?")) {
                appData[section][tab].splice(index, 1);
                saveData();
                renderList();
            }
        }

        function toggleCard(header) {
            const card = header.closest('.card');
            card.classList.toggle('expanded');
            const icon = header.querySelector('i');
            const textarea = card.querySelector('textarea');

            if(card.classList.contains('expanded')) {
                icon.classList.replace('ph-caret-down', 'ph-caret-up');
                setTimeout(() => autoExpand(textarea), 50);
            } else {
                icon.classList.replace('ph-caret-up', 'ph-caret-down');
            }
        }

        function saveCardText(section, tab, index, textarea) {
            autoExpand(textarea);
            appData[section][tab][index].text = textarea.value;
            saveData();
        }

        /* --- PLANNER LOGIC --- */
        function generateDates() {
            const container = document.getElementById('date-container');
            container.innerHTML = '';
            
            const today = new Date();
            
            // Generate 3 days
            for(let i=0; i<3; i++) {
                const d = new Date(today);
                d.setDate(today.getDate() + i);
                
                const dayNum = d.getDate();
                const monthShort = d.toLocaleDateString('en-GB', { month: 'short' });
                const dateKey = d.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                
                const chip = document.createElement('div');
                chip.className = `date-chip ${i===0 && !selectedDate ? 'active' : (selectedDate === dateKey ? 'active' : '')}`;
                chip.innerHTML = `<span>${dayNum}</span><span>${monthShort}</span>`;
                chip.onclick = () => selectDate(dateKey, chip);
                container.appendChild(chip);

                if (i===0 && !selectedDate) selectedDate = dateKey; 
            }
        }

        function selectDate(dateStr, el) {
            selectedDate = dateStr;
            document.querySelectorAll('.date-chip').forEach(c => c.classList.remove('active'));
            el.classList.add('active');
            renderPlanner();
        }

        function renderPlanner() {
            const listContainer = document.getElementById('planner-list');
            listContainer.innerHTML = '';
            
            const tasks = appData.planner[selectedDate] || [];
            
            if(tasks.length === 0) {
                listContainer.innerHTML = `<div style="text-align: center; opacity: 0.5; padding: 40px;">No plans for today yet.</div>`;
                return;
            }

            tasks.forEach((task, index) => {
                const div = document.createElement('div');
                div.className = 'task-item anim-pop';
                div.innerHTML = `
                    <input type="checkbox" class="task-checkbox" ${task.done ? 'checked' : ''} onchange="toggleTask(${index})">
                    <div class="task-content ${task.done ? 'done' : ''}">
                        <div class="task-name">${task.name}</div>
                        ${task.time ? `<span class="task-time"><i class="ph ph-clock"></i> ${task.time}</span>` : ''}
                    </div>
                    <i class="ph ph-trash task-del" onclick="deleteTask(${index})"></i>
                `;
                listContainer.appendChild(div);
            });
        }

        function openAddTaskModal() {
            const select = document.getElementById('task-select');
            select.innerHTML = '<option value="">Select Task...</option>';
            appData.tasks.forEach(t => {
                select.innerHTML += `<option value="${t}">${t}</option>`;
            });
            document.getElementById('task-custom').value = '';
            document.getElementById('task-from').value = '';
            document.getElementById('task-to').value = '';
            openModal('modal-add-task');
        }

        function syncTaskInput() {
            const sel = document.getElementById('task-select');
            const inp = document.getElementById('task-custom');
            if(sel.value) inp.value = sel.value;
        }

        function confirmAddTask() {
            const name = document.getElementById('task-custom').value || "Task";
            const tFrom = document.getElementById('task-from').value;
            const tTo = document.getElementById('task-to').value;
            let timeStr = "";
            if(tFrom && tTo) timeStr = `${tFrom} - ${tTo}`;
            else if(tFrom) timeStr = tFrom;
            
            if(!appData.planner[selectedDate]) appData.planner[selectedDate] = [];
            
            appData.planner[selectedDate].push({
                name: name,
                time: timeStr,
                done: false
            });
            saveData();
            renderPlanner();
            closeModal('modal-add-task');
        }

        function toggleTask(index) {
            appData.planner[selectedDate][index].done = !appData.planner[selectedDate][index].done;
            saveData();
            renderPlanner();
        }

        function deleteTask(index) {
            appData.planner[selectedDate].splice(index, 1);
            saveData();
            renderPlanner();
        }

        function openTaskPoolEdit() {
            document.getElementById('pool-edit-area').value = appData.tasks.join(', ');
            openModal('modal-pool');
            setTimeout(() => autoExpand(document.getElementById('pool-edit-area')), 50);
        }

        function saveTaskPool() {
            const val = document.getElementById('pool-edit-area').value;
            appData.tasks = val.split(',').map(t => t.trim()).filter(t => t);
            saveData();
            closeModal('modal-pool');
        }

        /* --- SETTINGS --- */
        function toggleTheme() {
            appData.settings.dark = !appData.settings.dark;
            if(appData.settings.dark) document.body.setAttribute('data-theme', 'dark');
            else document.body.removeAttribute('data-theme');
            saveData();
        }

        function changeName() {
            const newName = prompt("Enter new name:", appData.user);
            if(newName) {
                appData.user = newName;
                saveData();
                document.getElementById('planner-name').innerText = newName;
            }
        }

        function openReadme() {
            openModal('modal-readme');
        }

        function backupData() {
            const dataStr = JSON.stringify(appData);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = 'Target_Backup.json';
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function restoreData(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    appData = JSON.parse(e.target.result);
                    saveData();
                    initApp();
                    alert("Restored successfully!");
                } catch(err) {
                    alert("Invalid Backup File");
                }
            };
            reader.readAsText(file);
        }

        function resetData() {
            if(confirm("Permanently delete all data?")) {
                localStorage.removeItem('targetAppData');
                location.reload();
            }
        }

        /* --- MODAL UTILS --- */
        function openModal(id) {
            const m = document.getElementById(id);
            m.style.display = 'flex';
            setTimeout(() => m.querySelector('.modal').classList.add('open'), 10);
        }
        function closeModal(id) {
            const m = document.getElementById(id);
            m.querySelector('.modal').classList.remove('open');
            setTimeout(() => m.style.display = 'none', 300);
        }
function saveDailyNote(el) {
            autoExpand(el);
            appData.dailyNote = el.value;
            saveData();
        }
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then((reg) => console.log('Service Worker Registered'))
                    .catch((err) => console.log('Service Worker Failed', err));
            });
        }
    </script>
</body>
</html>